#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
Enhanced Blackjack GUI Application with improved architecture
"""

import tkinter as tk
from tkinter import ttk, messagebox, scrolledtext, filedialog
import json
from datetime import datetime
from typing import Dict, Any, Optional

from gui_base import BaseGUI, GridLayoutMixin, ValidationMixin, StatusBarMixin
from blackjack_analyzer import BlackjackAnalyzer
from config import UIConfig, AppConfig
from utils import ValidationError, FileManager

class EnhancedBlackjackGUI(BaseGUI, GridLayoutMixin, ValidationMixin, StatusBarMixin):
    """Enhanced Blackjack GUI with improved architecture and error handling"""
    
    def __init__(self, root: tk.Tk):
        super().__init__(root, AppConfig.UIText.APP_TITLE)
        
        # Initialize components
        self.analyzer = BlackjackAnalyzer()
        
        # GUI components
        self.player_entry: Optional[tk.Entry] = None
        self.dealer_entry: Optional[tk.Entry] = None
        self.result_label: Optional[tk.Label] = None
        self.history_tree: Optional[ttk.Treeview] = None
        self.status_bar: Optional[tk.Label] = None
        
        # Statistics variables
        self.total_games_var = tk.StringVar(value="0")
        self.win_rate_var = tk.StringVar(value="0.00%")
        self.wins_var = tk.StringVar(value="0")
        self.losses_var = tk.StringVar(value="0")
        
        self.setup_ui()
        self.update_status(self.status_bar, "Ready")
        
    def setup_ui(self) -> None:
        """Setup the complete user interface"""
        self._create_title_section()
        self._create_main_panels()
        self._create_history_section()
        self._create_status_bar()
    
    def _create_title_section(self) -> None:
        """Create the title section"""
        title_frame = tk.Frame(self.root, bg=UIConfig.Colors.BACKGROUND_DARK)
        title_frame.pack(fill='x', padx=10, pady=10)
        
        title_label = ttk.Label(
            title_frame, 
            text=AppConfig.UIText.APP_TITLE, 
            style='Title.TLabel'
        )
        title_label.pack()\n        input_frame.grid(row=0, column=0, sticky='nsew', padx=(0, 5), pady=0)\n        input_frame.grid_propagate(False)\n        \n        self.configure_grid_weights(input_frame, cols={0: 1})\n        \n        # Player cards input\n        self.create_label(\n            input_frame, \n            AppConfig.UIText.PLAYER_CARDS_LABEL,\n            font=UIConfig.Fonts.NORMAL\n        ).grid(row=0, column=0, sticky='w', padx=10, pady=(10, 5))\n        \n        self.player_entry = self.create_entry(input_frame)\n        self.player_entry.grid(row=1, column=0, padx=10, pady=(0, 5), sticky='ew')\n        \n        self.create_label(\n            input_frame,\n            AppConfig.UIText.EXAMPLE_TEXT,\n            fg_color=UIConfig.Colors.WARNING,\n            font=UIConfig.Fonts.SMALL\n        ).grid(row=2, column=0, padx=10, pady=(0, 10), sticky='w')\n        \n        # Dealer cards input\n        self.create_label(\n            input_frame,\n            AppConfig.UIText.DEALER_CARDS_LABEL,\n            font=UIConfig.Fonts.NORMAL\n        ).grid(row=3, column=0, sticky='w', padx=10, pady=(0, 5))\n        \n        self.dealer_entry = self.create_entry(input_frame)\n        self.dealer_entry.grid(row=4, column=0, padx=10, pady=(0, 5), sticky='ew')\n        \n        self.create_label(\n            input_frame,\n            \"Example: Q,6,5\",\n            fg_color=UIConfig.Colors.WARNING,\n            font=UIConfig.Fonts.SMALL\n        ).grid(row=5, column=0, padx=10, pady=(0, 10), sticky='w')\n        \n        # Buttons\n        self._create_input_buttons(input_frame)\n        \n        # Result display\n        self._create_result_display(input_frame)\n    \n    def _create_input_buttons(self, parent: tk.Widget) -> None:\n        \"\"\"Create input section buttons\"\"\"\n        button_frame = tk.Frame(parent, bg=UIConfig.Colors.BACKGROUND_MEDIUM)\n        button_frame.grid(row=6, column=0, sticky='ew', padx=10, pady=10)\n        self.configure_grid_weights(button_frame, cols={0: 1})\n        \n        add_btn = self.create_button(\n            button_frame,\n            AppConfig.UIText.ADD_GAME_BUTTON,\n            self.add_game,\n            UIConfig.Colors.SUCCESS,\n            height=UIConfig.Dimensions.BUTTON_HEIGHT\n        )\n        add_btn.grid(row=0, column=0, sticky='ew', pady=(0, 5))\n        \n        clear_btn = self.create_button(\n            button_frame,\n            AppConfig.UIText.CLEAR_BUTTON,\n            self.clear_inputs,\n            UIConfig.Colors.WARNING,\n            UIConfig.Colors.BLACK,\n            height=UIConfig.Dimensions.SMALL_BUTTON_HEIGHT\n        )\n        clear_btn.grid(row=1, column=0, sticky='ew')\n    \n    def _create_result_display(self, parent: tk.Widget) -> None:\n        \"\"\"Create result display area\"\"\"\n        result_frame = tk.Frame(\n            parent, \n            bg=UIConfig.Colors.BACKGROUND_MEDIUM,\n            height=UIConfig.Dimensions.RESULT_FRAME_HEIGHT\n        )\n        result_frame.grid(row=7, column=0, sticky='ew', padx=10, pady=10)\n        result_frame.grid_propagate(False)\n        self.configure_grid_weights(result_frame, cols={0: 1})\n        \n        self.result_label = self.create_label(\n            result_frame,\n            \"\",\n            font=UIConfig.Fonts.HEADER,\n            wraplength=300,\n            justify='center'\n        )\n        self.result_label.grid(row=0, column=0, sticky='ew')\n    \n    def _create_statistics_panel(self, parent: tk.Widget) -> None:\n        \"\"\"Create the statistics panel\"\"\"\n        stats_frame = self.create_label_frame(\n            parent,\n            AppConfig.UIText.STATISTICS_SECTION,\n            UIConfig.Dimensions.PANEL_WIDTH,\n            UIConfig.Dimensions.PANEL_HEIGHT\n        )\n        stats_frame.grid(row=0, column=1, sticky='nsew', padx=(5, 0), pady=0)\n        stats_frame.grid_propagate(False)\n        \n        self.configure_grid_weights(stats_frame, rows={0: 1}, cols={0: 1})\n        \n        # Statistics display\n        stats_container = tk.Frame(stats_frame, bg=UIConfig.Colors.BACKGROUND_MEDIUM)\n        stats_container.grid(row=0, column=0, sticky='nsew', padx=10, pady=10)\n        self.configure_grid_weights(stats_container, cols={0: 1})\n        \n        self._create_statistics_display(stats_container)\n        self._create_action_buttons(stats_container)\n    \n    def _create_statistics_display(self, parent: tk.Widget) -> None:\n        \"\"\"Create statistics display widgets\"\"\"\n        stats_data = [\n            (\"ðŸ“Š Total Games:\", self.total_games_var),\n            (\"ðŸŽ¯ Win Rate:\", self.win_rate_var),\n            (\"âœ… Wins:\", self.wins_var),\n            (\"âŒ Losses:\", self.losses_var)\n        ]\n        \n        for i, (label_text, var) in enumerate(stats_data):\n            stat_frame = tk.Frame(\n                parent, \n                bg=UIConfig.Colors.BACKGROUND_MEDIUM,\n                height=UIConfig.Dimensions.STAT_FRAME_HEIGHT\n            )\n            stat_frame.grid(row=i, column=0, sticky='ew', pady=2)\n            stat_frame.grid_propagate(False)\n            self.configure_grid_weights(stat_frame, cols={1: 1})\n            \n            self.create_label(\n                stat_frame,\n                label_text,\n                font=UIConfig.Fonts.NORMAL,\n                width=15,\n                anchor='w'\n            ).grid(row=0, column=0, sticky='w', padx=(0, 10))\n            \n            self.create_label(\n                stat_frame,\n                \"\",\n                textvariable=var,\n                fg_color=UIConfig.Colors.WARNING,\n                font=UIConfig.Fonts.NORMAL,\n                width=10,\n                anchor='e'\n            ).grid(row=0, column=1, sticky='e')\n    \n    def _create_action_buttons(self, parent: tk.Widget) -> None:\n        \"\"\"Create action buttons for statistics panel\"\"\"\n        button_configs = [\n            (AppConfig.UIText.DETAILED_STATS_BUTTON, self.show_detailed_stats, UIConfig.Colors.INFO),\n            (AppConfig.UIText.SAVE_DATA_BUTTON, self.save_data, UIConfig.Colors.PRIMARY),\n            (AppConfig.UIText.LOAD_DATA_BUTTON, self.load_data, UIConfig.Colors.SECONDARY)\n        ]\n        \n        for i, (text, command, color) in enumerate(button_configs):\n            btn = self.create_button(\n                parent,\n                text,\n                command,\n                color,\n                height=UIConfig.Dimensions.BUTTON_HEIGHT\n            )\n            btn.grid(row=i + 5, column=0, sticky='ew', pady=5)\n    \n    def _create_history_section(self) -> None:\n        \"\"\"Create the game history section\"\"\"\n        history_frame = self.create_label_frame(\n            self.root,\n            AppConfig.UIText.GAME_HISTORY_SECTION\n        )\n        history_frame.pack(fill='both', expand=True, padx=10, pady=(5, 10))\n        \n        # Treeview for history\n        tree_container = tk.Frame(history_frame, bg=UIConfig.Colors.BACKGROUND_MEDIUM)\n        tree_container.pack(fill='both', expand=True, padx=10, pady=10)\n        \n        columns = ('Game', 'Player', 'Dealer', 'Result')\n        self.history_tree = ttk.Treeview(\n            tree_container,\n            columns=columns,\n            show='headings',\n            height=UIConfig.Dimensions.TREEVIEW_HEIGHT\n        )\n        \n        # Configure columns\n        for col in columns:\n            self.history_tree.heading(col, text=col)\n            self.history_tree.column(col, width=120, anchor='center')\n        \n        # Scrollbar\n        scrollbar = ttk.Scrollbar(\n            tree_container,\n            orient='vertical',\n            command=self.history_tree.yview\n        )\n        self.history_tree.configure(yscrollcommand=scrollbar.set)\n        \n        # Pack treeview and scrollbar\n        self.history_tree.pack(side='left', fill='both', expand=True)\n        scrollbar.pack(side='right', fill='y')\n        \n        # Clear history button\n        clear_btn = self.create_button(\n            history_frame,\n            AppConfig.UIText.CLEAR_HISTORY_BUTTON,\n            self.clear_history,\n            UIConfig.Colors.DANGER\n        )\n        clear_btn.pack(pady=(5, 10))\n    \n    def _create_status_bar(self) -> None:\n        \"\"\"Create status bar\"\"\"\n        self.status_bar = self.create_status_bar(self.root)\n        self.status_bar.pack(side='bottom', fill='x')\n    \n    def add_game(self) -> None:\n        \"\"\"Add a new game with improved error handling\"\"\"\n        try:\n            # Validate required fields\n            fields = {\n                \"Player Cards\": self.player_entry,\n                \"Dealer Cards\": self.dealer_entry\n            }\n            \n            if not self.validate_required_fields(fields):\n                return\n            \n            player_cards = self.player_entry.get().strip()\n            dealer_cards = self.dealer_entry.get().strip()\n            \n            # Add game using analyzer\n            self.analyzer.add_game(player_cards, dealer_cards)\n            \n            # Get last game result\n            last_game = self.analyzer.games[-1]\n            result_text = self.analyzer.get_result_text(last_game['result'])\n            \n            # Update result display\n            self.result_label.config(\n                text=f\"ðŸŽ¯ {result_text}\\n\"\n                     f\"Player: {last_game['player_total']} | \"\n                     f\"Dealer: {last_game['dealer_total']}\"\n            )\n            \n            # Update interface\n            self.update_stats()\n            self.update_history()\n            self.clear_inputs()\n            \n            self.update_status(self.status_bar, \"Game added successfully\", UIConfig.Colors.SUCCESS)\n            \n        except ValidationError as e:\n            self.show_error(str(e))\n            self.update_status(self.status_bar, f\"Error: {str(e)}\", UIConfig.Colors.DANGER)\n        except Exception as e:\n            error_msg = f\"Unexpected error: {str(e)}\"\n            self.show_error(error_msg)\n            self.update_status(self.status_bar, error_msg, UIConfig.Colors.DANGER)\n    \n    def clear_inputs(self) -> None:\n        \"\"\"Clear input fields\"\"\"\n        fields = {\n            \"player\": self.player_entry,\n            \"dealer\": self.dealer_entry\n        }\n        self.clear_fields(fields)\n    \n    def update_stats(self) -> None:\n        \"\"\"Update statistics display\"\"\"\n        stats = self.analyzer.get_statistics()\n        \n        self.total_games_var.set(str(stats['total_games']))\n        self.wins_var.set(str(stats['wins']))\n        self.losses_var.set(str(stats['losses']))\n        \n        if stats['total_games'] > 0:\n            win_rate = (stats['wins'] / stats['total_games']) * 100\n            self.win_rate_var.set(f\"{win_rate:.2f}%\")\n        else:\n            self.win_rate_var.set(\"0.00%\")\n    \n    def update_history(self) -> None:\n        \"\"\"Update game history display\"\"\"\n        # Clear existing data\n        for item in self.history_tree.get_children():\n            self.history_tree.delete(item)\n        \n        # Add new data\n        for i, game in enumerate(self.analyzer.games, 1):\n            self.history_tree.insert('', 'end', values=(\n                i,\n                f\"{game['player_cards']} ({game['player_total']})\",\n                f\"{game['dealer_cards']} ({game['dealer_total']})\",\n                game['result'].upper()\n            ))\n    \n    def show_detailed_stats(self) -> None:\n        \"\"\"Show detailed statistics in a new window\"\"\"\n        if self.analyzer.stats['total_games'] == 0:\n            self.show_info(AppConfig.Messages.NO_DATA_WARNING)\n            return\n        \n        # Create detailed stats window\n        detail_window = tk.Toplevel(self.root)\n        detail_window.title(\"Detailed Statistics\")\n        detail_window.geometry(\"450x550\")\n        detail_window.configure(bg=UIConfig.Colors.BACKGROUND_DARK)\n        \n        # Scrolled text widget\n        text_widget = scrolledtext.ScrolledText(\n            detail_window,\n            wrap=tk.WORD,\n            font=('Courier', 10),\n            bg='#212529',\n            fg='white'\n        )\n        text_widget.pack(fill='both', expand=True, padx=10, pady=10)\n        \n        # Generate statistics text\n        stats = self.analyzer.get_statistics()\n        detail_text = self._generate_detailed_stats_text(stats)\n        \n        text_widget.insert(tk.END, detail_text)\n        text_widget.config(state='disabled')\n    \n    def _generate_detailed_stats_text(self, stats: Dict[str, Any]) -> str:\n        \"\"\"Generate detailed statistics text\"\"\"\n        total = stats['total_games']\n        \n        return f\"\"\"ðŸƒ DETAILED BLACKJACK STATISTICS\n{'=' * 50}\n\nðŸ“Š GENERAL INFORMATION:\n  â€¢ Total Games: {stats['total_games']}\n  â€¢ Wins: {stats['wins']}\n  â€¢ Losses: {stats['losses']}\n  â€¢ Pushes: {stats['pushes']}\n  â€¢ Blackjacks: {stats['blackjacks']}\n  â€¢ Busts: {stats['busts']}\n\nðŸŽ¯ PERFORMANCE ANALYSIS:\n  â€¢ Win Rate: {(stats['wins']/max(total, 1)*100):.2f}%\n  â€¢ Blackjack Rate: {(stats['blackjacks']/max(total, 1)*100):.2f}%\n  â€¢ Bust Rate: {(stats['busts']/max(total, 1)*100):.2f}%\n  â€¢ Push Rate: {(stats['pushes']/max(total, 1)*100):.2f}%\n\nðŸ“… REPORT DATE: {datetime.now().strftime('%d.%m.%Y %H:%M')}\n\"\"\"\n    \n    def save_data(self) -> None:\n        \"\"\"Save game data to JSON file\"\"\"\n        try:\n            filename = FileManager.generate_filename()\n            data = {\n                'games': self.analyzer.games,\n                'stats': self.analyzer.stats,\n                'export_date': datetime.now().isoformat()\n            }\n            \n            with open(filename, 'w', encoding='utf-8') as f:\n                json.dump(data, f, indent=2, ensure_ascii=False)\n            \n            success_msg = AppConfig.Messages.DATA_SAVED.format(filename)\n            self.show_info(success_msg)\n            self.update_status(self.status_bar, success_msg, UIConfig.Colors.SUCCESS)\n            \n        except Exception as e:\n            error_msg = f\"Save error: {str(e)}\"\n            self.show_error(error_msg)\n            self.update_status(self.status_bar, error_msg, UIConfig.Colors.DANGER)\n    \n    def load_data(self) -> None:\n        \"\"\"Load game data from JSON file\"\"\"\n        try:\n            filename = filedialog.askopenfilename(\n                title=\"Select Data File\",\n                filetypes=[(\"JSON files\", \"*.json\"), (\"All files\", \"*.*\")]\n            )\n            \n            if not filename:\n                return\n            \n            with open(filename, 'r', encoding='utf-8') as f:\n                data = json.load(f)\n            \n            if not FileManager.validate_json_structure(data):\n                self.show_error(\"Invalid file format!\")\n                return\n            \n            self.analyzer.games = data.get('games', [])\n            self.analyzer.stats = data.get('stats', {})\n            \n            self.update_stats()\n            self.update_history()\n            \n            success_msg = AppConfig.Messages.DATA_LOADED.format(filename)\n            self.show_info(success_msg)\n            self.update_status(self.status_bar, success_msg, UIConfig.Colors.SUCCESS)\n            \n        except Exception as e:\n            error_msg = f\"Load error: {str(e)}\"\n            self.show_error(error_msg)\n            self.update_status(self.status_bar, error_msg, UIConfig.Colors.DANGER)\n    \n    def clear_history(self) -> None:\n        \"\"\"Clear all game history\"\"\"\n        if self.ask_yes_no(AppConfig.Messages.CLEAR_CONFIRMATION):\n            self.analyzer.games = []\n            self.analyzer.stats = {\n                'total_games': 0, 'wins': 0, 'losses': 0, 'pushes': 0,\n                'blackjacks': 0, 'busts': 0\n            }\n            \n            self.update_stats()\n            self.update_history()\n            self.result_label.config(text=\"\")\n            \n            self.show_info(\"All data cleared!\")\n            self.update_status(self.status_bar, \"All data cleared\", UIConfig.Colors.SUCCESS)\n\ndef main():\n    \"\"\"Main function to run the enhanced application\"\"\"\n    root = tk.Tk()\n    app = EnhancedBlackjackGUI(root)\n    root.mainloop()\n\nif __name__ == \"__main__\":\n    main()